---
layout: post
title: Como copiar regras de uma Security List
subtitle: Como clonar regras de uma security list para outra com OCI CLI
tags: [Cloud, Oracle, OCI, CLI, Security List, Ingress, Egress]
comments: true
---

## Requisitos

| OCID da subnet de origem | Obrigatório |
| OCID da subnet de destino | Obrigatório |

Em algum momento trabalhando com Oracle Cloud terá a necessário copiar/replicar security list para outros ambientes, seja para obter alta disponibilidade, trabalhar com multiplas regiões ou simplesmente para criar um lab para testes. Caso tenha SL com muitas regras isso pode se tornar uma tarefa difício, imagine adicionar 100 regras ou mais uma a uma via console da cloud.

## Obtenha o OCID das subnets de origem e destino

Navegue até **Networking > Virtual Cloud Networks > Virtual Cloud Network Details > Security Lists**

Copie o OCID da Security List de Origem, observe as 133 regras entre Ingress Rules e Egress Rules.

![sl-01](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/q82YoxDl9YNIqQVaY_HTQcrYpJ9G-NNM_L-N2HcR45BDndmjCXtgjY1n1sQ3Tn8F/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/SL/SL-01.png)

Copie o OCID da Security List de Destino

![sl-02](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/iuzMo3mnLh7s49Yb5k2La7pGaX8FXLgGeQQXoUqPZOKnFtBrGTCuqXyMwishakMh/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/SL/SL-02.png)

## Copiando regras da security list de origem

Via interface gráfica copiar e atualizar as regras de uma SL para outra leva muito tempo, mas com o OCI CLI a mesma tarefa leva apenas alguns segundos, e vamos usar os dois seguintes comandos.

```javascript
$ oci network security-list get --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaabcsvprvix3wkw5p4we5cvjafpskeaio6kjr2ltbe3dhq6dr5osyq
```

Observe que o output é toda a estrutura da security list com informações de compartment, display name, egress-security-rules, ingress-security-rules. Mas vamos precisar apenas **egress-security-rules** e **ingress-security-rules.**

![sl-03](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/6nTOGtixADq2P2yWeMa2khOKo29kyFBktaXtNh6D3O95FgBVBLhHkpMAzAX2VnsW/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/SL/SL-03.png)

Para filtrar apenas os dados necessários, será utilizado o **jq** que é um processador de linha de comando para JSON. Será feito em duas etapas para **egress-security-rules** e **ingress-security-rules.**

**Regras de Egress**

```javascript
$ oci network security-list get --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaabcsvprvix3wkw5p4we5cvjafpskeaio6kjr2ltbe3dhq6dr5osyq | jq '.data."egress-security-rules"'
```

Com isso o output tras apenas as regras de egress. 

![sl-04](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/06x4M8ETVAmHwANfB_OWD5f1-BQDde2wH1NGU6ifkyI7I90zQPBES3L_7Px8EnZ3/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/SL/SL-04.png)

Adicione as regras de egress a ser "clonadas" para o arquivo egress.json.

```javascript
$ oci network security-list get --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaabcsvprvix3wkw5p4we5cvjafpskeaio6kjr2ltbe3dhq6dr5osyq | jq '.data."egress-security-rules"' > egress.json
```

Então atualize a security list de destino com as regras contidas no arquivo egress.json, use o OCID da security list de destino. 

```javascript
$ oci network security-list update --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaa6irvzcxv65aralnk5bt7wzinqhqkgghrbxiepoh5caeu77yafeta --egress-security-rules file://egress.json
```

**Regras de Ingress**

Basta repitir o passos da task anterior agora apontando para Ingress.

```javascript
$ oci network security-list get --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaabcsvprvix3wkw5p4we5cvjafpskeaio6kjr2ltbe3dhq6dr5osyq | jq '.data."ingress-security-rules"'
```

Com isso o output tras apenas as regras de ingress. 

![sl-05](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/93eRlG7Icbd1lxKhjhnQPuV-WPBOG-Nxpyd89WTRk98z4bRds3phzR8tRsqfPBW-/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/SL/SL-05.png)

Adicione as regras de ingress a ser "clonadas" para o arquivo ingress.json.

```javascript
$ oci network security-list get --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaabcsvprvix3wkw5p4we5cvjafpskeaio6kjr2ltbe3dhq6dr5osyq | jq '.data."ingress-security-rules"' > ingress.json
```

Então atualize a security list de destino com as regras contidas no arquivo ingress.json, use o OCID da security list de destino. 

```javascript
$ oci network security-list update --security-list-id ocid1.securitylist.oc1.sa-saopaulo-1.aaaaaaaa6irvzcxv65aralnk5bt7wzinqhqkgghrbxiepoh5caeu77yafeta --ingress-security-rules file://ingress.json
```

![sl-06](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/06x4M8ETVAmHwANfB_OWD5f1-BQDde2wH1NGU6ifkyI7I90zQPBES3L_7Px8EnZ3/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/SL/SL-04.png)





Verifique se seus limites permitem adicionar uma nova região em **Governance > Limits, Quotas and Usage** com os seguintes filtros.

![limite-01](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/U-veHKuEauMe2X0hJmlvYA6WaX945GZwtX4b4QyDXh1MWjkmGNtb_UE134XcnZdE/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/limite-01.png)

Caso o service limit seja igual que o número de regiões utilizadas você precisará abrir um SR para aumentar o limite conforme abaixo, caso o service limit seja maior pule essa etapa.

**Criar SR:** Abra um SR para aumentar o limite de regiões clicando em request a service limit increase.

![limite-02](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/RnncV9tl817nUiJbnoIJZnqqBQZZyGiC-hzd5neAExlrOTxGdiPocuztQmYrPfpt/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/limite-02.png)

Preencha com os dados da sua conta.

- Name
- E-mail
- Service Category: Regions
- Resource: Subscribed region count
- Tenancy Limit: 6
- Reason for Request: Increase the limite so that you can subscribe to other OCI regions.

![limite-03](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/d8FAPnSGSJz2KYh-no3l7zFJn0HRrjK7rgg-ZUB3SRdAR-9tXy19mzqRen7iSssX/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/limite-03.png)

Aguarde até que o SR seja finalizado para prosseguir. Em média leva 24 horas para ser atendido, quando seu SR for encerrado você receberá um e-mail como esse.

![limite-04](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/R4GnwP-f6bslqhHxBg4APfyEDRlwKmUPPKtv4f2MN4GWSNiWt3-gxXc3TIln9pH-/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/limite-04.png)

## Habilitando nova região

Clique na sua Home Region no meu caso é **Brasil East(São Paulo)** e depois em **Manage Regions**.

![region-01](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/O3Q-NcLpHiuROoKNStL9_4NsBHkAmz72Y2Mkz9PkW-wwopUXFzB_fuOyQF_qFSTr/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/region-01.png)

Clique em **Subscribe** a direita da região que deseja adicionar.

![region-02](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/Apztf9VqEqtwJeL2QwdCO_p_FSoKMEQGUhC_5lw-rxlW7DyjCf9Q56Hwm1koxg0c/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/region-02.png)

Verifique se confere com a região desejada e confirme clicando em **Subscribe**. 

**OBS:** Não é possível remover uma região depois de adicionada.

![region-03](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/HA4BPrGIKFK9jh6VL54TBUOp5Pxu_Zp9HuOYhINoOBd2tAwp_7IbnvjzTVBHjsSi/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/region-03.png)

Aguarde pelo menos 10 minutos para que a nova região esteja disponível.

![region-04](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/do8huo_43GAe0Be4c5Ag6EiUX1yNCA4kEcLedyAQig9cK-QNbk5i2J4Lv5Pv7K_R/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/region-04.png)

Alterne entre regiões clicando em Home Region e depois na região recém adicionada.

![region-05](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/ahY8acBrGWyEWKmcrmXIg5anOr0MeHa3umuoTGshr8xt12NVdffHK9bcPZHZpIHh/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/region-05.png)

Liste todas as regiões habilitadas no Tenancy para confirmar que a nova região está realmente disponível, para isso use o OCI CLI local caso tenha configurado ou via Cloud Shell.

```javascript
$ oci iam region-subscription list --query "data [*].{\"Regiao\":\"region-name\"}" --output table
```

![region-06](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/urBkT8gkVVFExuwr1n1q_8ytRDH-LC1zB7-nYA8upFXs7jnL8bHHldbuC7uKIAMY/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/NEW-REGION/region-06.png)



