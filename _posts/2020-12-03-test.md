---
layout: post
title: Automatizando Power On/Off de recursos OCI que não operam 24/7
subtitle: Economize habilitando o Power On/Off em recursos que não operam 24/7
tags: [Cloud, Oracle, OCI, CLI, Visual Builder Studio, DevCS, Cost, Schedule, Shell]
comments: true
---

## Porque automatizar Power On/Off de recursos que não operam 24/7?

Os recursos na Oracle Cloud Infrastructure como na maioria dos Cloud Providers são faturados por horas de uso, logo quanto maior o tempo de uso maior o custo, mas o recurso provisionado não é cobrado durante o tempo em que permanece desligado. 

Caso possua um ambiente não produtivo e sem a necessidade de permanecer ligado 24/7, manter estes recursos desligados durante a madrugada e finais de semanas pode significar uma boa economia no fim do mês.

Se uma empresa que possue ambientes de desenvolvimento e homologação que são utilizados apenas durante o horário comercial. Caso essa mesma empresa mantenha os recursos desligados durante os períodos entre 21:00 e 7:00 e durante todo o fim de semana a economia com estes 2 ambientes pode chegar a 60% após 1 mês

## Automatizando Power On/Off

Foram criados scripts em shell com comando do OCI-CLI para realizar o stop e start dos recursos. Acesse o repositório do [GitHub](https://smallskills.github.io/2021-01-17-Create-VBS-And-Link-To-OCI/) e baixe os scripts.

- Instances
- Instance Pool
- Oracle Analytics Cloud
- Autonomous Database
- DBSystem Database
- Exatada Database

É necessário dois scripts para cada recurso, sendo um para stop e um para start.

## Oracle Visual Builder Studio

VB Studio será utilizado para executar a ação de stop e start dos recursos, caso não tenha o VB Studio configurado siga este [tutorial](https://smallskills.github.io/2021-01-17-Create-VBS-And-Link-To-OCI/) antes de prosseguir.

Os scrits podem ser facilmente configurados para rodar no Azure DevOps caso por algum motivo o VB Studio não seja um opção.

**Crie uma Virtual Machine Template**

Acesse o VB Studio indo até **Platform Services > Developer.**

![ss-01](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Vá até **Virtual Machines Templates > Create Template.**

![ss-02](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Adicione um nome para o template e em Platform selecione Oracle Linux 7.

![ss-03](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Clique em **Configure Software** e adicione os seguintes software packages **OCIcli** e **Python3.**

![ss-04](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)
 
![ss-05](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

**Crie uma Virtual Machine**

Essa será a virtual machine em onde seus scritps serão rodados, essa VM pode ser uma Always Free que não gera custos. A instance será totalmente gerenciada pelo VB Studio. 

Vá até **Virtual Machines > Create.**

![ss-06](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Selecione a quantidade de instances, a região, o shape e aponte o template recém criado.  

![ss-07](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Clique em start para que a instance seja provisionada e aguarde até o status seja running.

![ss-08](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

**Crie um projeto no VB Studio**

Vá até **Projects > Create.**

![ss-09](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Dê o nome Power On-Off para o projeto.

![ss-10](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Selecione Empty Project e clique em next.

![ss-11](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Selecione Markdonw e clique em finish.

![ss-12](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

**Create Git Repository**

Vá até **Git > Create Repository.**

![ss-13](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Dê o nome git-power-on-off para Git Repository.

![ss-14](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Clique em Add File para adicionar um novo arquivo.

![ss-15](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Selecione o nome da pasta que o arquivo será salvo + o nome do arquivo e então arraste o arquivo do script para area de código. Clique em commit e repita isso para todos os outros arquivos.

![ss-16](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

**Aproveite para editar os scripts com os OCIDs do seu tenancy.**

**Create Build**

Vá até **Build > Create Build.**

![ss-17](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Dê um nome para o build e selecione o template que foi configurado anteriomente.

![ss-18](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Clique em **Add Git.**

![ss-19](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Selecione o repositório do Git criado anteriomente e clique em save.

![ss-20](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Vá até **Steps** e clique em **Add Step** e selecione OCIcli.

Preecha com os dados do seu tenancy, utilize o usuário criado durante a configuração do VB Studio ou crie outro com permissões compativéis. Recomendo a utilização de keys sem passphrase, pois obtive muitos erros ao utilizar keys com a passphrase.

![ss-21](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Adicione um novo **Step. Dessa vez escolha Common Builf Tools > Unix Shell.** 


















Na console do Oracle Cloud Infrastructure navegue até **More Oracle Cloud Services > Platform Services > Developer.**

![ss-01](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/xj9srMULWogekAo4GNV_I-rU75T6l4Cxtig3GmIFes5wnFNfQKatXs-AwB0CyBrV/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-01.png)

Na aba Instances clique em **Create Instance** para criar uma conta do Oracle Visual Builder Studio.

![devcs-02](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/tMVMvHIDz9T777hrWHd8sfPnThf8C2QNJa1MXcOHejHvZn7RKkM_xvIB4zxypCw9/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-02.png)

Preencha com as informações da sua conta, avance e clique em **Create.**

![devcs-03](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/3ldIcVDC7y6iFlhiLjBJP-_vF3TDyP6gdJbW95kPIDTuNZ6-2YIdhdJdMIJgRSbk/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-03.png)

Para acessar o ambiente do VB Studio clique no ícone à direita e então **Access Service Instance.**

![devcs-04](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/hX-XmUMptic4G4UVyEtQAPm9FjCla2CTNvlnwTwOtZO2PHvt35iadW-TV8NNsvbP/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-04.png)

Essa é a console do VB Studio.

![devcs-05](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/D42zzldyfTg0mRS-zl9aHbqd3uN2sV0U-wjlYpJWBardlE6YH57WzKDJyh3vh_DT/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-05.png)

## Vinculando conta OCI Cloud ao VB Studio

Para concluir esse step é necessário provisionar alguns recursos na OCI são eles:

- 1 Compartment
- 1 IAM User
- 1 par de SSH Keys (private e public) no formato PEM.
- 1 Group
- 1 Policy

**Compartment:** Na console do OCI navegue até **Identity > Compartment > Create Compartment.**

![devcs-06](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/Wxet3-q_bZJCOuMm9m7rtsHzvaefixxv1iIWUu7snyvTorehtT2TxIS7Yp1_9zu0/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-06.png)

**IAM User:** Na console do OCI navegue até **Identity > Users > Create User.**

![devcs-07](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/70iZR2WmNMD2XdSpuFSs6OM5lsIqeW_ELU8gkZzVwLsahn2I2VUrn1Wv5DHJCJMk/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-07.png)

**SSH Keys:** Na console do OCI navegue até **Identity > Users > Clique no usuário recém criado > API Keys > Add API Key** use a SSH Key única criada pela Oracle e faça download, pois será utilizada nos próximos passos ou use suas próprias SSH Keys. 

![devcs-08](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/QH6gkquH1MdVAvo2cNpfnufW98KuJXp1WE5GuVUYgZVWnNBbH24EAq9Wgj52aeFZ/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-08.png)

Copie as informações presente no **Configuration File Preview.**

![devcs-09](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/hotJ-KPyDL5lWX5wCH9WQRDEBXRCK509DVTZWaq7HUBHzDs6kDot2GiteLJquldF/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-09.png)

**Group:** Na console do OCI navegue até **Identity > Groups > Create Group.** 

![devcs-10](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/GQVUXR3NGnDIbT-DMBDarCN_0WgdPRLgaGQVcy6JZdPirvR8iCpqBTMaG-_crXpa/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-10.png)

Clique em **Add User to Group**

![devcs-10-b](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/B3ZGL-uwd7CgBDYwuLXxMPd7MA1mko4Ab9J-trUEL1NN_sZpcnB-ojw4vsxkCH0T/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-10-b.png)

**Policies:** Na console do OCI navegue até **Identity > Policies > Create Policy.**

Em Policy Builder adicione permissão para o grupo **GROUP-OVBC** gerenciar todos os recursos no compartment **COMPARTMENT-OVBC** recém criado e permissão de leitura em todo o tenancy.

```javascript
allow group GROUP-OVBC to manage all-resources in compartment COMPARTMENT-OVBC
allow group GROUP-OVBC to read all-resources in tenancy
```

![devcs-11](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/evol2tcaJ69ejd_hKBZG1WobyzAdXtvH1OziNIFwBTmRzbzH6WFiDNakQR1IY_vE/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-11.png)

Retorne para a console do VB Studio e vá até **Organization > OCI Account > Clique em Connect**

![devcs-12](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/fDJOieuxLpNuK_ZQQ4Hnp4NNQtWxlFDmeazSwoVfGS8Q6rmCAGLrhlnMVjszRFFD/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-12.png)

Para **Tenancy OCID, User OCID, Home Region e Fingerprint** use os dados presente no Configuration File Preview.

Para **Compartment OCID** Vá até **Identity > Compartment > COMPARTMENT-OVBC** e copie o OCID.

Para **Storage Namespace** Vá até **Administration > Tenancy Details** e copie o valor da **Object Storage Namespace.**

![devcs-13](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/nJG6bckt8q_DwkvtFomfe8vvrJYdp5MCuOGeaSd7bA6NrPGMjiSuk0Lc6jHrt7Xu/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/DEVCS/devcs-13.png)

Agora você é capaz de criar projetos integrados com Visual Builder Studio e Oracle Cloud Infrastructure.


