---
layout: post
title: Como criar VCN, Subnet, Internet Gateway e Route Table na Oracle Cloud
subtitle: Três formas de criar uma Virtual Cloud Network, Subnet, Internet Gateway e Route Table na Oracle Cloud Infrastructure
tags: [Cloud, Oracle, OCI, CLI, VCN, Subnet, Internet Gateway, Route Table]
comments: true
---

## Requisitos

| Uma conta Oracle Cloud | Obrigatório |

## Usando OCI-CLI

**Tenancy::** Obtenha o OCID do seu Tenancy.

```javascript
$ export tenancy_id=$(oci iam compartment list --all --include-root --query "data[?contains(\"id\",'tenancy')].id | [0]" --raw-output)  
```

**Compartment:** Crie o compartment a VCN será criada.

```javascript
$ export compartment_id=$(oci iam compartment create --compartment-id $tenancy_id --description cli-test --name compartment-test-cli --query "data.id" --raw-output)
```

**VCN:** Para criar uma VCN é necessário informar o compartment, cidr block, nome da VCN e um DNS label é recomendável utilizar o nome da VCN sem os caracteres especiais.

```javascript
$ export vcn_id=$(oci network vcn create --compartment-id $compartment_id --cidr-block "10.0.0.0/16" --display-name vcn-cli-test --dns-label vcnclitest --query "data.id" --raw-output)
```

**Public Subnet:** Com a VNC criada adicione uma public subnet.

```javascript
$ export public_subnet_id=$(oci network subnet create --vcn-id $vcn_id --compartment-id $compartment_id --cidr-block "10.0.0.0/24" --display-name public-subnet --dns-label publicsubnet --query "data.id" --raw-output)
```

**Private Subnet:** Crie também uma private subnet adicionando "--prohibit-public-ip-on-vnic true".

```javascript
$ export private_subnet_id=$(oci network subnet create --vcn-id $vcn_id --compartment-id $compartment_id --prohibit-public-ip-on-vnic true --cidr-block "10.0.1.0/24" --display-name private-subnet --dns-label privatesubnet --query "data.id" --raw-output)
```

**Intenet Gateway:** Para que a VCN tenha conexão com a internet crie um Internet Gateway.

```javascript
$ export internet_gateway_id=$(oci network internet-gateway create --compartment-id $compartment_id --is-enabled true --vcn-id $vcn_id --display-name IG-cli-test --query "data.id" --raw-output)
```

**Route Table:** Crie uma nova route table e adicione uma regra, neste caso para toda a internet com cidr block 0.0.0.0/0.

```javascript
$ rt_id=$(oci network route-table create --compartment-id $compartment_id --route-rules '[{"cidrBlock":"0.0.0.0/0","networkEntityId":"'$internet_gateway_id'"}]' --vcn-id $vcn_id --display-name route-table-cli --query "data.id" --raw-output)
```

Associe a route table a public subnet.

```javascript
$ oci network subnet update --subnet-id $public_subnet_id --route-table-id $rt_id
```

## Usando VCN Wizard

Acesse a console administrativa da Oracle Cloud Infrastructure e navegue até Networking > Virtual Cloud Networks > .

Selecione o compartment desejado e click em **Start VCN Wizard.**

![Wizard-01](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/elm_Z_qoSXZhZzQFIe9F8qfSgRVY4bWRIZ7bTfFIzbgJL7x-gij3be0vB2CVqMx7/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-01.png)

Escolha a opção **VCN with Internet Connectivity** para criar uma VCN com conexão com a internet, ou seja todos os recursos necessário para conectividade externa será criada.

![Wizard-02](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/Gqq3Wwt2GxPnZZLt9AqBb2fomv24IQ9Mx4Pp_Ha67X5ON_m3Ohqzz2qtWyqmiDA1/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-02.png)

Dê um nome para a VCN, você pode seguir com as configurações default ou alterar o VCN CIDR BLOCK, Public Subnet CIDR BLOCK e Private Subnet CIDR BLOCK para um tamanho mais adequado.

![Wizard-03](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/3UsjiWjUmCsCwj7y3wQZnXMzoMIVGxxBzNMHZL0olndzvH16676lGLXxGFWaYvN0/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-03.png)

![Wizard-04](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/o8Ayy2Z9WKCcFjHG2UF3cXBN5-eG3nbIlzGXoR-FLhhyhILGpAeqV9CdOd1S3iG4/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-04.png)

![Wizard-05](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/yRQHxfPW4z3oS4qc5dQCKN6cBs-z8YjfHT2xjmB1gQ_yx8keelpj04t4Rl8blvd8/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-05.png)

![Wizard-06](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/SxD8rWfmkBRgGbOADp40wuNzRpxaOoOA5Ui7ekG0b8Bczp1XlWPfN-IJt5hI8aHj/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-06.png)

![Wizard-07](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/ENEs-ejd6RoNUvU6-KLqmMZjW6GuftqiYh41TbRhsYmp05skG4vWeS9mqtBNqIqE/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/POST-VCN/wizard-07.png)

Caso a instalação tenha sido bem sucedida receberá um output como esse.

![Oci-Help](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/E4YcwQoBdQsKXZm8fVrLci4xiInG0FiRaGWSQfNEXxVXJAmfiSXS-3-PPKoWV2Vr/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/oci-help.png)

## Configurando Oracle Cloud Infrastructure CLI

Com o CLI instalado, agora é preciso configura-lo. Nesta etapa será necessário user OCID e tenancy OCID.

**Obtendo User OCID e Tenancy OCID** 

User OCID: Navegue até Identity>Users>Seu User

![User-Ocid](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/np_zGbe9Zaz9UINKmPcGJhRIxsGrUHuVEEcDhLG6RQow1d6SMvspygRAq_UCpzff/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/user-ocid.png)

Tenancy OCID: Navegue até Administration>Compartment>Tenancy Details

![Tenancy-Ocid](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/AgiXs372OaF4Jl9P2gdjVXpgceo-c_u7So_hh2oFnDolVOGFv3VwgCEniswKKxQB/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/tenancy-ocid.png)

Para iniciar o processo de configuração execute o comando abaixo, aceite as configurações default ou personalize conforme a necessidade. Salve o diretório de armazenamento do arquivo config e SSH Key.

```javascript
oci setup config
```
![Oci-Setup](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/Wu9yqvH68zmY2b7VbxXnbi1pwXZl54R7-YfNC8WVNpf-kz_xCczdbvMNjpwQagLy/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/oci-setup-config.png)

Nesta etapa será criada uma API Keys e será utilizado a public key recém criada nesse processo.

**MacOS/Linux**

Preencha com as suas infomações (caminho/nome da public key) apontadas no momento da confinguração.

```javascript
$ cd /home/ubuntu/.oci/
$ vim oci_api_key_public.pem 
```
Copie o conteúdo completo da Public Key.

![Public-Key](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/vOVDjB3xmwdJUYLaQRSVXluCGDaCtPUbN0gv6At8kYdtnrgLK5wJSptvLISA0nxT/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/public-key.png)

**Windows**

Abra a Public Key com notepad e copie todo o conteúdo.

![Public-Key-Windows](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/vOVDjB3xmwdJUYLaQRSVXluCGDaCtPUbN0gv6At8kYdtnrgLK5wJSptvLISA0nxT/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/public-key.png)

Acesse a console Oracle Cloud e vá atá o caminho Identity>Users>Seu User>API Keys>Add API Key.

Selecione "Paste Public Key", cole o conteúdo da Public Key e clique em Add.

![Api-Key](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/GFEO45ZEfNHoh4PEG-JULwJJ5h-sPIdLFyc8kRyIUiPalFoyrwEd4CdkCPVZhnT2/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/api-key.png)

Após adicionada a API Key é gerada um Fingerprint. 

![Finger-Print](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/J-fdWrzqA79ic4IYMXvSTJg0gslBP0R1KeGY4wfuY0jFus4Kx0ZTago6Uhi2QtJc/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/fingerprint.png)

Visualize o arquivo de configuração.

**MacOS/Linux**

```javascript
$ cd /home/ubuntu/.oci/
$ cat config
```

![Config-Cat](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/QP1n5BBih4rC9YNK2DSH5bS3xtB5NJZSqtGeIsJr-xsNbuZqbf1ucSKhplx_QIm7/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/config.png)

**Windows**

Navegue até o diretório do arquivo config e abra com notepad.

![Config-Cat-Windows](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/uEdpaH0pQjgD4EQ04W7AqkVGFTqKIkaWt180qI7FpypikIpvb46_hukwPIV3qbT3/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/config-windows.png)

Certifique-se que a configuração foi bem sucedida listando os compartments do Tenancy.

```javascript
$ oci iam compartment list
```

![Compartment-List](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/FmAMKaP-SLgK1KhRNlVZGlXRsg0qTQD0PPydkh4BnKz7z7R3Usd8p64-Td6J0Jpc/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/compartment-list.png)

## Deploy de uma Instance VM com OCI-CLI

Após instalar, configurar e certificar-se que tudo funciona bem com OCI-CLI, siga os passos abaixo para criar uma Instance VM via CLI.

Para essa task será necessario as seguintes recursos:

| Recurso | Onde Conserguir |
| :------ |:--- |
| Availability Domain | CLI-OCI |
| Compartment OCID | CLI-OCI |
| Subnet OCID | CLI-OCId |
| Image OCID | CLI-OCI |
| Name Shape | Site Oracle Cloud |
| Display Name | Defina um Nome | 
| SSH Key | Gerar durante Deploy |

**Availability Domain:** Salve o OCID do availability domain.

```javascript
$ oci iam availability-domain list --query "data [*].{\"Name\":\"name\"}" --output table
```

**Compartimet OCID:** Salve o OCID do compartment que deseja criar a Instance VM.

```javascript
$ oci iam compartment list --lifecycle-state active --query "data [*].{\"Name\":\"name\",\"id\":\"id\"}" --output table
```

**Subnet OCID:** Substitua o valor do --compartment-id pela OCID do compartiment listado acima onde sua subnet está alocada. Salve o OCID da subnet.

```javascript
$ oci network subnet list --compartment-id ocid1.compartment.oc1..aaaaaaaa2tjqxvk2oxw45php23trjixcrzwb3bhzhcw4qqjpjcpvozny6mza --query "data [*].{\"Name\":\"display-name\",\"id\":\"id\"}" --output table
```

**Imagem OCID:** Substitua o valor do --compartment-id pela OCID do compartiment listado acima onde será realizado o deploy da Instance VM. Salve o OCID da imagem desejada, nesta task será utilizada a Oracle-Linux-7.9-2020.11.10-1, mas é possível escolher qualquer [imagem disponível na Oracle Cloud Infrastructure](https://docs.cloud.oracle.com/en-us/iaas/images/).

```javascript
$ oci compute image list --compartment-id ocid1.compartment.oc1..aaaaaaaayu2eqzztrf7nrvi2dc5h2vl2rw2xoqphiucblfg7ossq7rzc5wsq --query "data [?contains(\"display-name\",'Oracle-Linux-7.9')].{\"IMAGE\":\"display-name\",\"ID\":\"id\"}" --output table
```

**Shape:** Utilize o shape **Always Free** para testes, consulte todos os shapes disponíveis no site oficial [Oracle Cloud Infrastructure.](https://docs.cloud.oracle.com/en-us/iaas/Content/Compute/References/computeshapes.htm)

![Resources-Get](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/pACSZBitORcnthvHOrTAg4R5nFyflz6fP3Es08mvZ4kxE8nwsYt10ZzAcwRwpHDY/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/resource-get.png)

**Iniciando Deploy da Instance VM**

Inicie criando um diretório para armazenar a SSH Key.

```javascript
$ mkdir keys
```

Gerando uma nova SSH Key. Substitua pelo caminho que deseja salvar a SSH Key, por exemplo C:\Keys no Windows. 

```javascript
$ ssh-keygen -t rsa -N "" -b 2048 -C "CiCd-Compute-Instance" -f /home/ubuntu/keys/key-test
```

Faça o deploy da Instance VM utilizando as informações salvas anteriomente availability-domain, compartment-id, shape, subnet-id, image-id, display-name, ssh-authorized-keys-file e adicione o parâmetro assign-public-ip como true para que seja atribuído um IP público na Instance VM.

```javascript
$ oci compute instance launch --availability-domain syxp:SA-SAOPAULO-1-AD-1 --compartment-id ocid1.compartment.oc1..aaaaaaaa2tjqxvk2oxw45php23trjixcrzwb3bhzhcw4qqjpjcpvozny6mza --shape VM.Standard.E2.1.Micro --subnet-id ocid1.subnet.oc1.sa-saopaulo-1.aaaaaaaa2j4d7too2lkyjtlzujdegwl3m37tpoqxilnsyunykc2nh3fy65kq --image-id ocid1.image.oc1.sa-saopaulo-1.aaaaaaaa7inha53kcyutiqdbz3w4gvms2ab5z3bc624loheugh7fbvg4wada --assign-public-ip true --display-name instance-vm-teste --ssh-authorized-keys-file /home/ubuntu/keys/key-test.pub
```

Aguarde até que o estado da Intance VM seja Running.

![VM-Run](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/frjmu6F0Z5y29QjmRqTmV8xDhwrUcLPBHN6E0NsT6p3loROKM2m6-BPcNFlAXsqL/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/running-instance.png)

Acesse a Instance VM recém criada.

**MacOS/Linux**

```javascript
$ chmod 400 /home/ubuntu/keys/key-test
$ ssh -i /home/ubuntu/keys/key-test opc@152.67.40.241
```

![Access-macos](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/MiuLVTjjSNXUtaqxJCT_CAI0z4Ia9B7OUbOE87GjmXgOorvN5fL3b-kICe9tbZhT/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/access-macos.png)

**Windows**

Instale o [MobaXterm](https://mobaxterm.mobatek.net/), abra uma nova sessão e acesse a Instance VM.

```javascript
$ chmod 400 'C:\keys\key-test'
$ ssh -i 'C:\keys\key-test' opc@152.67.40.241
```

![Acess-Windows](https://objectstorage.sa-saopaulo-1.oraclecloud.com/p/MKR3wsGjo5S0o1C-i19XtWHpINaXKoPA0qFYYNqCus9fUhkXl4I7jW-sue1tZbU6/n/gr8gkzaf8nit/b/bucket-euoraf4-site/o/2020-11-30-Configurando-OCI-CLI/access-windows.png)

Agora você é capaz de acessar o OCI-CLI e criar Instances VMs na Oracle Cloud Infrastructure.
